Variables:
    dpics: /volumes/macdrive/projects/text2video/dpics
    font_color: white
    font_size: 100
    init_height: 200
    p2v: yes
Tube:
    # get dynamic video bg
    - cd: {dpics}
    - get_keys: -f news.yaml
    - run: Pic2V --if p2v

    # geneate news2.txt file
    - set_var: news_file = news2.txt
    - run: WriteNewsToFile -v line_size = 10
    - f_read: -f {news_file} -v lines
    - f_del: news2.txt

    # write each news line into video
    - set_var: input = dpics2temp.mp4
    - f_cp: -s dpics2.mp4 -d {input}
    - run: WriteLine2V --each line in lines -v output=temp.mp4
    
    # play output
    - cmd: ffplay {input}

WriteLine2V:
    - cmd: >
        ffmpeg -y -i {input} -vf 
        "drawtext=fontsize={font_size}:fontcolor={font_color}:
            fontfile='../fonts/未央简体.ttf':
            text='{line}':
            borderw=3:bordercolor=black:
            x=20:y={init_height}" 
        {output}
    - f_cp: -s {output} -d {input}
    - set_var: init_height = init_height + 1.5 * font_size -g

WriteNewsToFile:
    - set_var: size = 10
    - set_var: size = line_size --if line_size != 'line_size'
    - set_var: i = 0
    - f_empty: '{news_file} -c'
    - set_var: loop_times = int(len(content)/size+1)
    - run: WriteLineToText --while i < loop_times

WriteLineToText:
    - set_var: line = content[i*size:i*size+size].strip()
    - write_line: -f {news_file} -v {line} --if len(line) > 0
    - set_var: i = i + 1 -g

Pic2V:    
    - break: testing break --if no

    - set_var: dw = 1000        # delta width
    - set_var: tw = 1080 + dw   # temp width
    - cmd: >
        ffmpeg -y -i bg.png -filter:v 
        "scale={tw}:1920:force_original_aspect_ratio=increase,crop={tw}:1920" 
        bg_whd.png
        --note 把下载的图片调成为 1080+dw:1920 像素

    # 把图片裁成250份，用作frames，稍后用来做动态图片视频
    - set_var: fcount = 250
    - set_var: sw = dw/fcount  # slice width
    - set_var: ls = list(range(0,fcount))
    - f_del: tmp/*.img
    - run: CutPic --each i in ls

    # 用前面做出来的250份frames 生成图片动态视频
    - cmd: ffmpeg -y -r 25 -i tmp/img%03d.jpg -pix_fmt yuv420p -vcodec libx264 dpics2.mp4
    - f_del: tmp/img*.jpg
    
CutPic:
    - set_var: pic_name_out = 'tmp/img{:03d}.jpg'.format(i)
    - set_var: x = dw - sw * i
    - cmd: >
        ffmpeg -y -i bg_whd.png -filter:v
        "crop=1080:1920:{x}:0"
        {pic_name_out}

Variables:
    text2video_root: /volumes/macdrive/projects/text2video
    downloads: /Users/lianglianghan/downloads
    output_final_draft: 'video_final_draft.mp4'
    output_final: 'video_final.mp4'
    output_final_prefix: 'video_final_'
    downloaded: no
    t2v: yes # If re-generate the 'video_init.mp4'   
    dpics: yes
    del: yes 
    # settings for dynamic drawing text
    video_duration:
    start: 6
    duration: 5
    text: TEXT
    font_size: 55
    delta_h: 60
    x: (w-text_w)/2
    y: h-th-20
    color: white
Tube:
    # step 1: Get 'video_init.mp4' and backgournd pictures
    - PATH: {downloads}
    - COMMAND: rm 未命名*.mp4 --continue --if {del}
    - COMMAND: rm *.ass --continue --if {del}
    - PATH: {text2video_root}
    - GET_FILE_KEY_VALUE: -f ./t_article.yaml --override
    - COMMAND: python3 s_t2v.py ./t_article.yaml --if {t2v}    
    # Wating the video download to be finished
    - RUN_TUBE: -y t_wv.yaml -w {downloaded} == no --if {t2v}
    - PATH: {downloads}
    # get video download file name
    - COMMAND: ls -tr ./*.mp4 | tail -1 | awk -F '/' '{print "vname="$NF}' > video_init_name.txt --if {t2v}
    # get subtitle file name
    - COMMAND: ls -tr ./*.ass | tail -1 | awk -F '/' '{print "cname="$NF}' > caption_init_name.txt --if {t2v}
    - PAUSE: 0.05
    # load video name and caption init name to variables
    - GET_FILE_KEY_VALUE: -f video_init_name.txt --if {t2v}
    - GET_FILE_KEY_VALUE: -f caption_init_name.txt --if {t2v}
    - PATH: {text2video_root}
    - COMMAND: mkdir -p ./tmp
    - COMMAND: cp -f '{downloads}/{vname}' {text2video_root}/tmp/video_init.mp4  --if {t2v}
    - COMMAND: cp -f '{downloads}/{cname}' {text2video_root}/tmp/subtitle.ass  --if {t2v}
    # remove backgound pictures  
    - PATH: '{text2video_root}/tmp'
    - COMMAND: rm bg*.jpg --continue --if {dpics} {del}
    - PATH: {text2video_root}
    # get background pictures
    - GET_FILE_KEY_VALUE: -f t_apikeys.yaml
    - COMMAND: python3 s_downpics.py ./t_apikeys.yaml '{keywords}' 20 ./tmp --if {dpics}
    
    # # step 2: Split init video into pieces
    # # currently it seems limition be default it could split them into 10 seconds
    # # less than 10 seconds video doesn't work
    - PATH: '{text2video_root}/tmp'
    - COMMAND: rm -f video_init_*.mp4 --continue
    - COMMAND: rm -f video_final_*.mp4 --continue
    - COMMAND: >
        ffmpeg -y -i video_init.mp4 -acodec copy -f segment -segment_time 10 
        -vcodec copy -reset_timestamps 1 -map 0 video_init_%2d.mp4

    # # step 3: Add background for each splited videos
    # # and output combined video: video_final_draft.mp4
    - PATH: {text2video_root}
    - COMMAND: python3 s_pv.py ./tmp

    # # step 4: Add title
    - PATH: '{text2video_root}/tmp'
    - COMMAND: >
        ffmpeg -y -i {output_final_draft} 
        -vf "drawtext=fontfile='/library/Fonts/Arial Unicode.ttf':text='{title}':
        fontcolor=yellow:fontsize=125:enable='between(t,0,5)':
        box=1:boxcolor=black@0.6:boxborderw=5:x=(w-text_w)/2:y=(h/2):expansion=none"
        -codec:a copy -y {output_final_prefix}t1.mp4
    - COMMAND: >
        ffmpeg -y -i {output_final_prefix}t1.mp4
        -vf "drawtext=fontfile='/library/Fonts/Arial Unicode.ttf':text='{sub_title}':
        fontcolor=#2B39FF:fontsize=60:enable='between(t,0,5)':
        box=1:boxcolor=yellow@0.8:boxborderw=5:x=(w-text_w)/2:y=(h/2 + 2.5*text_h):expansion=none"
        -codec:a copy -y {output_final_prefix}t2.mp4
    # add sub title backend box
    - COMMAND: >
        ffmpeg -y -i {output_final_prefix}t2.mp4 -vf "drawbox=x=300:y=945:w=1320:h=80:color=black@0.8:t=fill" {output_final_prefix}t2b.mp4
    # add subtitle
    - COMMAND: >
        ffmpeg -y -i {output_final_prefix}t2b.mp4 -vf 'ass=subtitle.ass' -c:a copy {output_final_prefix}t2bc.mp4

    # Add weathers
    - PATH: {text2video_root}
    - COMMAND: python3 s_weathers.py {HEFENG_API_KEY} 'changchun,sanya,xian,chongqing,shenzhen,shanghai,beijing' d_weathers.txt
    - GET_FILE_KEY_VALUE: -f d_weathers.txt
    - PATH: '{text2video_root}/tmp'
    - COMMAND: >
        ffmpeg -i {output_final_prefix}t2bc.mp4 
          -vf "drawtext=fontfile='/library/Fonts/Arial Unicode.ttf':
               fontcolor=yellow:
               fontsize=50:
               text='{weathers}':
               x=mod(150*t\,w+tw)-tw:y=1:
               box=1:boxcolor=black@0.8"
          -codec:a copy -y {output_final_prefix}t3.mp4
    
    # # Step 5: Add logo
    - PATH: '{text2video_root}/tmp'
    - COMMAND: >
        ffmpeg -y -i {output_final_prefix}t3.mp4 -i cnBeta.png 
        -filter_complex "[1:v]colorkey=0xffffff:0.3:0.2[ckout];[0:v][ckout]overlay=50:80[out]" 
        -map "[out]" -map 0:a:0 -c:a copy {output_final_prefix}tl.mp4
    
    # logo
    - COMMAND: >
        ffmpeg -y -i {output_final_prefix}tl.mp4 -i Rnews.jpg
        -filter_complex 
            "[1:v]colorkey=0x00ff00:0.3:0.2[ckout];
            [0:v][ckout]overlay=x=-50:y=935[out]" 
        -map "[out]" -map 0:a:0 -c:a copy {output_final_prefix}tl2.mp4

    # Add dynamic dates detail text
    - PATH: {text2video_root}
    - COMMAND: python3 s_gdates.py
    - GET_FILE_KEY_VALUE: -f d_date_detail.txt
    - PATH: '{text2video_root}/tmp'

    # draw gongli
    - SET_VARIABLE: -n text -v {gongli} {xingqi} [{xingzuo}]    
    - SET_VARIABLE: -n x -v 100
    - SET_VARIABLE: -n y -v 1080/3*2
    - SET_VARIABLE: -n dt_input -v {output_final_prefix}tl2.mp4 
    - SET_VARIABLE: -n dt_output -v {output_final_prefix}tl2_dates.mp4  
    - RUN_TUBE: -y ../t_dtext.yaml

    # draw nongli
    - SET_VARIABLE: -n text -v {yTG_DZ}{nongli} {shengXiao}
    - SET_VARIABLE: -n y -v 1080/3*2 + {delta_h}
    - SET_VARIABLE: -n start -v {start} + 2
    - SET_VARIABLE: -n dt_input -v {output_final_prefix}tl2_dates.mp4 
    - SET_VARIABLE: -n dt_output -v {output_final_prefix}tl2_dates2.mp4 
    - SET_VARIABLE: -n font_size -v {font_size} - 8
    - RUN_TUBE: -y ../t_dtext.yaml

    # draw jieqi
    - SET_VARIABLE: -n text -v {jieQi} {jieQi_Date}
    - SET_VARIABLE: -n y -v 1080/3*2 + {delta_h} * 2
    - SET_VARIABLE: -n start -v {start} + 2
    - SET_VARIABLE: -n dt_input -v {output_final_prefix}tl2_dates2.mp4  
    - SET_VARIABLE: -n dt_output -v {output_final_prefix}tl2_dates3.mp4 
    - SET_VARIABLE: -n font_size -v {font_size} - 8
    - RUN_TUBE: -y ../t_dtext.yaml

    # # Step 6: Genearte the final one
    - PATH: '{text2video_root}/tmp'
    - COMMAND: cp -f {output_final_prefix}tl2_dates3.mp4  {output_final}
    - COMMAND: rm -f video_init_*.mp4 --continue --if {del}
    - COMMAND: rm -f video_final_*.mp4 --continue --if {del}
    - COMMAND: rm d_filelist.txt --continue --if {del}
    - COMMAND: ffplay {output_final}